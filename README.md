# Shared Voronoi Global Planner

## Description
This global planner generates several paths in homotopically distinct classes (i.e. the paths generated can not be deformed into another without colliding with an obstacle).

This is done using the JCash Voronoi C implementation (https://github.com/JCash/voronoi). The nodes generated by the library is then converted into an adjacency matrix for use in graph-based path finding algorithms.

A* path finding algorithm with Euclidean distance heuristics is used to find the shortest path, subsequent k-th shortest paths are found using Yen's algorithm.

## Subscribers
`/move_base/global_costmap/costmap [nav_msgs/OccupancyGrid]:` Subcribes to global costmap to generate voronoi diagram

`/move_base/global_costmap/costmap_updates [nav_msgs/OccupancyGrid]:` Subscribes to global costmap updates. This topic is published on when the map is not static, ie gmapping is running.

`/move_base/local_costmap/costmap [nav_msgs/OccupancyGrid]:` Subscribes to local costmap. Local costmap is merged with global costmap during generation of voronoi diagram.

`/user_vel [geometry_msgs/Twist]:` Topic to receive user's direction. Max forward velocity and angular velocity *has to* have the same limits.

## Publishers
`~/merged_costmap [nav_msgs/OccupancyGrid]:` Merged costmap of local and global costmaps. Used for ensuring that the global planner is using the correct map to generate voronoi diagram.

`~/plan [nav_msgs/Path]:` Currently selected path that is being sent to the local planner for execution.

`~/all_paths [visualization_msgs::MarkerArray]:` Visualization markers for all paths generated.

`~/user_direction [visualization_msgs::Marker]:` Visualization marker for the current user direction.

`~/voronoi_edges [visualization_msgs::MarkerArray]:` Visualization markers for voronoi edges and singly connected nodes (red points on the map).

## Params
`occupancy_threshold:` Integer threshold of costmap pixels before it is considered an occupied cell, which will then be used to generate the voronoi diagram.

`collision_threshold:` Integer threshold of costmap pixels before it is considered a collision. This threshold is used during the pruning of generated voronoi edges, as well as during path smoothing.

`update_voronoi_rate:` Rate at which to update the voronoi diagram, Hz.

`update_costmap_rate:` Rate at which to update the internal costmap, which affects the voronoi diagram generated, Hz.

`print_timings:` Set true to print all timing related information into the console. Mainly for debugging/optimization purposes.

`line_check_resolution:` Pixel resolution to increment during checking of collision. Value of 0.5 will check if a line has a collision every 0.5 pixels. Floating point pixels are cast to integer before checking, therefore this parameter might have little effect.

`pixels_to_skip:` Pixels to skip when reading through the costmap to get occupied cells for voronoi diagram generation. 0 means all pixels will be read. 1 means for every 1 pixel read, 1 pixel will be skipped before reading again.

`open_cv_scale:` Used to downscale the costmap image for faster performance during finding of obstacle centroids. Value ranges from 0 to 1.0, exclusive.

`h_class_threshold:` Percentage threshold used to classify if a path is of a different h_class. A value of 0.01 means a 1% difference is sufficient to classify a path in another class. Note that only small values are required for this.

`min_node_sep_sq:` Minimum distance in meters squared between 2 points. This is used during the smoothing phase of the generated voronoi paths. A value of 1 means that if 2 subsequent nodes in the generated voronoi path is less than 1 pixel apart, the smoothing will delete the pixels until 2 subsequent nodes are greater than 1 pixel apart.

`extra_point_distance:` Distance (m) to place the extra point during the bezier smoothing to ensure continuity of the smoothed path. This param is currently quite hardcoded, in the sense that this distance should be a function of something else, but is not yet implemented. Default value is 1.0.

`add_local_costmap_corners:` Option to add the 4 corners of the local costmap as virtual obstacles. This helps to generate a voronoi diagram even in an empty field when no other obstacles are detected.

`forward_sim_time:` This value affects the length of user direction, which plays a part in selecting the closest matching path to the user's direction.

`num_paths:` Number of paths to generate. Note that the number of paths generated greatly affects the performance of the global planner.

`publish_all_path_markers:` Set true to publish markers for all the paths.

`user_dir_filter:` Exponential filter on the user's direction. Default value is 0.0

`joystick_topic:` Topic to subscribe to for joystick values. Topic should be of type geometry_msgs/Twist

`visualize_edges:` Set true to publish all voronoi edges and singly-connected nodes to rviz. Note that occasionally the edges might spasm, but this only happens to the visualization, internally the edges are still correct.

`node_connection_threshold_pix:` Since the voronoi library generates nodes in terms of pixels, and in order to get the adjacency list, the nodes have to be "discretized" and given a unique hash; occasionally, nodes that are next to each other, which are technically the same node, will not be given the same hash. This param fixes the issue by finding singly connected nodes in the adjacency list, then connects it to the nearest node if it less than this param's threshold. This prevents broken edges in the adjacency list.